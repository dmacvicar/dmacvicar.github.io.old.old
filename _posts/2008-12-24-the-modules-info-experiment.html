---
layout: post
title: The module's info experiment
date: 2008-12-24 00:34:00.000000000 +01:00
type: post
published: true
status: publish
categories: []
tags:
- newkde
- newsuse
- software
- suse
- yast
meta:
  posterous_6c96d52da40a5d7e34be538822acc826_post_id: '48645291'
  posterous_6c96d52da40a5d7e34be538822acc826_permalink: http://duncan.mac-vicar.com/the-modules-info-experiment
author:
  login: duncan
  email: dmacvicar@gmail.com
  display_name: duncan
  first_name: Duncan
  last_name: Mac-Vicar P.
---

<p>This experiment is an idea from <a href="http://en.opensuse.org/User:Visnov">Stano</a>. When he saw us hacking and trying new approaches for the control center code base (in order to allow a different design) he sent me this ycp snippet.Â </p>
<div class="CodeRay">
<div class="code">
<pre>import <span class="s"><span class="dl">&quot;</span><span class="k">Mode</span><span class="dl">&quot;</span></span>;
Mode::SetMode( <span class="s"><span class="dl">&quot;</span><span class="k">autoinst_config</span><span class="dl">&quot;</span></span>);

string m = (string) WFM::Args(<span class="i">0</span>);
string p = (string) WFM::Args(<span class="i">1</span>);

y2milestone( <span class="s"><span class="dl">&quot;</span><span class="k">Writing the result of '%1' to '%2'</span><span class="dl">&quot;</span></span>, m, p);
any a = WFM::call( m, [<span class="s"><span class="dl">&quot;</span><span class="k">Read</span><span class="dl">&quot;</span></span>] );

any res = WFM::call( m, [<span class="s"><span class="dl">&quot;</span><span class="k">Summary</span><span class="dl">&quot;</span></span>] );
y2milestone( <span class="s"><span class="dl">&quot;</span><span class="k">%1</span><span class="dl">&quot;</span></span>, res);

SCR::Write( .target.string, p, res);</pre>
</div>
</div>
<p>  }</p>
<p>This snippet would called with two parameters, A and B, would run a ycp client in <a href="http://forgeftp.novell.com/yast/doc/SL11.1/autoinstall/devel/ar01s03.html">&ldquo;auto&rdquo; mode</a> and write a summary of the configuration in file B.</p>
<p>This would allow in the control panel to display &ldquo;status&rdquo; information about the modules before launching them.</p>
<p>To test the concept, I hacked a quick YModuleInfoProvider class that hooked into the Qt::Tooltip role of the YQModulesModel. I filled the implementation of this class with a hacky call to yast2, calling the ycp snippet and reading back the temporal file.</p>
<p>Ideally, the status should be shown in the icon itself or in a &ldquo;Dolphin&rdquo; like status bar. However, I just wanted to see it, so I put them in tooltips for now (Not that I want to keep them there).</p>
<p>And yes!, it works, you can see the status of some modules just h-overing them with your mouse:</p>
<p><img src="{{ site.baseurl }}/assets/7-module-status-1.png" alt="module status 1" /></p>
<p><img src="{{ site.baseurl }}/assets/7-module-status-2.png" alt="module status 1" /></p>
<p><img src="{{ site.baseurl }}/assets/7-module-status-3.png" alt="module status 1" /></p>
<p>I would like to replace the implementation of YModuleInfoProvider with code using the YaST2 component API instead of an external call, just to see if it is cleaner, faster and whether we have more control. Stano helped me making this snippet work:</p>
<div class="CodeRay">
<div class="code">
<pre>using namespace std;

<span class="pt">int</span> main()
{
    Y2Component *c = Y2ComponentBroker::createServer(<span class="s"><span class="dl">&quot;</span><span class="k">wfm</span><span class="dl">&quot;</span></span>);

    <span class="r">if</span> ( ! c )
    { cout &lt;&lt; <span class="s"><span class="dl">&quot;</span><span class="k">error talking to wfm</span><span class="dl">&quot;</span></span> &lt;&lt; endl; <span class="r">return</span> <span class="i">1</span>; }

    Y2Component *mode = Y2ComponentBroker::getNamespaceComponent(<span class="s"><span class="dl">&quot;</span><span class="k">Mode</span><span class="dl">&quot;</span></span>);

    <span class="r">if</span> ( ! mode )
    { cout &lt;&lt; <span class="s"><span class="dl">&quot;</span><span class="k">error finding component</span><span class="dl">&quot;</span></span> &lt;&lt; endl; <span class="r">return</span> <span class="i">1</span>; }

    Y2Namespace *ns = mode-&gt;import(<span class="s"><span class="dl">&quot;</span><span class="k">Mode</span><span class="dl">&quot;</span></span>);

    <span class="r">if</span> ( ! ns )
    { cout &lt;&lt; <span class="s"><span class="dl">&quot;</span><span class="k">error importing Mode namespace</span><span class="dl">&quot;</span></span> &lt;&lt; endl; <span class="r">return</span> <span class="i">1</span>; }

    Y2Function* fnc = ns-&gt;createFunctionCall(<span class="s"><span class="dl">&quot;</span><span class="k">SetMode</span><span class="dl">&quot;</span></span>, Type::fromSignature(<span class="s"><span class="dl">&quot;</span><span class="k">void(string)</span><span class="dl">&quot;</span></span>) );

    <span class="r">if</span> ( ! fnc )
    { cout &lt;&lt; <span class="s"><span class="dl">&quot;</span><span class="k">error calling SetMode</span><span class="dl">&quot;</span></span> &lt;&lt; endl; <span class="r">return</span> <span class="i">1</span>; }

    fnc-&gt;appendParameter( YCPString( <span class="s"><span class="dl">&quot;</span><span class="k">autoinst_config</span><span class="dl">&quot;</span></span> ) );
    fnc-&gt;finishParameters();
    fnc-&gt;evaluateCall();

    cout &lt;&lt; <span class="s"><span class="dl">&quot;</span><span class="k">Done call!</span><span class="dl">&quot;</span></span> &lt;&lt; endl;
    fnc = ns-&gt;createFunctionCall(<span class="s"><span class="dl">&quot;</span><span class="k">mode</span><span class="dl">&quot;</span></span>, Type::fromSignature(<span class="s"><span class="dl">&quot;</span><span class="k">string(void)</span><span class="dl">&quot;</span></span>) );
    <span class="r">if</span> ( ! fnc )
    { cout &lt;&lt; <span class="s"><span class="dl">&quot;</span><span class="k">error calling mode</span><span class="dl">&quot;</span></span> &lt;&lt; endl; <span class="r">return</span> <span class="i">1</span>; }

    YCPValue res = fnc-&gt;evaluateCall();
    cout &lt;&lt; res-&gt;toString() &lt;&lt; endl;

    <span class="r">return</span> <span class="i">0</span>;
}</pre>
</div>
</div>
<p>However, for this to work, it requires a small bug to be fixed in core. So I guess I will replace the implementations once this patch is in.</p>
