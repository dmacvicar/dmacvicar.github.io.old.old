---
layout: post
title: Introducing ZYpp services
date: 2008-09-18 23:19:00.000000000 +02:00
type: post
published: true
status: publish
categories: []
tags:
- newsuse
- suse
- zypp
meta:
  posterous_6c96d52da40a5d7e34be538822acc826_post_id: '48644942'
  posterous_6c96d52da40a5d7e34be538822acc826_permalink: http://duncan.mac-vicar.com/introducing-zypp-services
  _edit_last: '34818'
  _oembed_d91eee025838b86c331614faf105b76e: "{{unknown}}"
  _oembed_61d30bb5cd639bd6b9acad343a3f7084: "{{unknown}}"
author:
  login: duncan
  email: dmacvicar@gmail.com
  display_name: duncan
  first_name: Duncan
  last_name: Mac-Vicar P.
---
<h2>Credits</h2>
<p>The following cool stuff would have not been possible without the hard work of <a href="http://jniq.blogspot.com/">Jan Kupec</a>, <a href="http://lizards.opensuse.org/author/mlandres/">Michael Andres</a> and Michael Calmer, who implemented and tested this stuff. The original concept dates back from ZLM and the Novell Customer Center.</p>
<h2>Usecase #1: The project with multiple repositories and layers</h2>
<p>Imagine the following usecase (with this one I am using some real request from our KDE guys)</p>
<p>The build service provides a KDE4 repository. Which in turn requires the Qt4 repository, because is built on openSUSE 11.0 + the new Qt4 repo.</p>
<p>When looking at this problem, repository dependencies is what comes to head in the first place. But forget about them. If package dependencies are complicated right now, imagine adding a secondary (and duplicated) layer of information. Packages already know their dependencies.</p>
<p>Now imagine our KDE guys can provide an URL, which you add to zypper. And this url returns a dynamic list of repositories. And zypper adds and remove repositories based on the information returned by this url on every refresh.</p>
<h2>Usecase #2: Update repositories based on the customer</h2>
<p>This is actually where services where originated. Services were present in Novell ZenWorks. How it works?</p>
<p>The service url nu.novell.com is added to the system. But in this url also a customer id is present as a http username. When you registered, Novell knows the product this customer is linked to, and can return a dynamic list of update repositories based on the customer preferences, products and entitlements and the customer does not need to keep them in sync.</p>
<p>Now that we don&rsquo;t have Zenworks in the base system, we still want this cool functionality for our customers.</p>
<p>Technically, this even allows us to offer hotfixes to L3 supported customers on the fly!</p>
<h2>Usecase #3: Dynamic repository collections</h2>
<p>You are a build service user, and you have an account, and of course you have a list of watched projects you are interested to. What if you could keep your system repositores in sync with your watched project list.</p>
<p>Or what if the build service could offer a service based on keywords or other data: like <a href="http://build.opensuse.org/services/mostpopular/repo/repoindex.xml">http://build.opensuse.org/services/mostpopular/repo/repoindex.xml</a> would contain dynamically the 15 most popular repositories. You add that service, and then ZYpp does the work for you of adding new popular repositories, and remove the old ones.</p>
<h2>Quick test</h2>
<p>For a quick test, I needed a service provider, and I have none. I could have used our <a href="http://www.novell.com/linux/smt/">Subscription Management Tool</a>, which can act as a local proxy replacement of a Novell Update service provider, but I decided to implement a quick and dirty service that could be used as an example for other people that have nice ideas for this stuff.</p>
<p>So I created a rails application, a very simple one, that returns a dynamic <a href="http://en.opensuse.org/Standards/Repository_Index_Service">repository index</a> by searching for the &ldquo;emacs&rdquo; keyword using the <a href="http://api.opensuse-community.org/searchservice/Search/Simple/openSUSE_110/emacs">opensuse-community search API</a>.</p>
<pre>
[sourcecode language="ruby"]
require 'rexml/document'
require 'uri'

include REXML

class RepoController &amp;lt; ApplicationController

  def index

    # do a package search on a keyword
    f = open('http://api.opensuse-community.org/searchservice/Search/Simple/openSUSE_110/emacs')
    buffer = f.read
    doc = Document.new(buffer)
    repourls = Set.new

    counter = 0
    doc.elements.each('ns2:packages/package/repoURL') do | repourl |
      # get all repourls
      repourls.add repourl.text.to_s
    end

    # create the repoindex
    outdoc = Document.new
    root = Element.new('repoindex')
    outdoc.add_element root
    counter = 0
    repourls.each do |repourl|
      al = URI.parse(repourl).path.gsub(//repositories//, '').gsub(/[:]/, '').gsub(///, '_')
      root.add_element 'repo'  , { 'url' =&gt; repourl,
        'alias' =&gt; al }
    end

    render :xml =&gt; outdoc.to_s
  end
end
[/sourcecode]
</pre>
<p>And I need also to configure a route, as the service is searched in the service url + &quot;repo/repoindex.xml&quot;.</p>
<pre>
[sourcecode language="ruby"]
  map.connect ':controller/repoindex.xml', :action =&gt; 'index'
[/sourcecode]
</pre>
<p>Requesting my new service http://localhost:3000/repo/repoindex.xml returns me the following.</p>
<p>[sourcecode language="xml"]<br />
&lt;repoindex&gt;<br />
  &lt;repo url=&quot;http://download.opensuse.org/repositories/Education:/desktop/openSUSE_11.0&quot; alias=&quot;Education_desktop_openSUSE_11.0&quot;/&gt;<br />
   &lt;repo url=&quot;http://download.opensuse.org/repositories/server:/mail/openSUSE_11.0&quot; alias=&quot;server_mail_openSUSE_11.0&quot;/&gt;<br />
  &lt;repo url=&quot;http://download.opensuse.org/repositories/home:/tiwai/openSUSE_11.0&quot; alias=&quot;home_tiwai_openSUSE_11.0&quot;/&gt;<br />
  &lt;repo url=&quot;http://download.opensuse.org/repositories/home:/sjcundy/openSUSE_11.0&quot; alias=&quot;home_sjcundy_openSUSE_11.0&quot;/&gt;<br />
  &lt;repo url=&quot;http://download.opensuse.org/repositories/home:/hmacht/openSUSE_11.0&quot; alias=&quot;home_hmacht_openSUSE_11.0&quot;/&gt;<br />
  &lt;repo url=&quot;http://download.opensuse.org/repositories/home:/marcinzalewski/openSUSE_11.0&quot; alias=&quot;home_marcinzalewski_openSUSE_11.0&quot;/&gt;<br />
  &lt;repo url=&quot;http://download.opensuse.org/repositories/home:/beyerle/openSUSE_11.0&quot; alias=&quot;home_beyerle_openSUSE_11.0&quot;/&gt;<br />
  &lt;repo url=&quot;http://download.opensuse.org/repositories/home:/dsteuer/openSUSE_11.0&quot; alias=&quot;home_dsteuer_openSUSE_11.0&quot;/&gt;<br />
  &lt;repo url=&quot;http://download.opensuse.org/repositories/M17N/openSUSE_11.0&quot; alias=&quot;M17N_openSUSE_11.0&quot;/&gt;<br />
  &lt;repo url=&quot;http://download.opensuse.org/repositories/home:/jefferyfernandez/openSUSE_11.0&quot; alias=&quot;home_jefferyfernandez_openSUSE_11.0&quot;/&gt;<br />
  &lt;repo url=&quot;http://download.opensuse.org/distribution/11.0/repo/oss/suse&quot; alias=&quot;_distribution_11.0_repo_oss_suse&quot;/&gt;<br />
  &lt;repo url=&quot;http://download.opensuse.org/repositories/home:/maw:/bzr/openSUSE_11.0&quot; alias=&quot;home_maw_bzr_openSUSE_11.0&quot;/&gt;<br />
&lt;/repoindex&gt;<br />
[/sourcecode]</p>
<p>Adding your service can be done with zypper:</p>
<p>[sourcecode]<br />
# zypper sa http://localhost:3000 myservice<br />
Service 'myservice' has been successfully added.<br />
[/sourcecode]</p>
<p>As you may note, services have their own commands. every repository not part of a service is also a service. So working with repositories at the service level basically groups all repositories that belong to the same service.</p>
<p>Now, when you refresh the service:</p>
<p>[sourcecode]<br />
# zypper refs<br />
Refreshing service 'myservice'.<br />
Adding repository 'Education_desktop_openSUSE_11.0' [done]<br />
Adding repository 'server_mail_openSUSE_11.0' [done]<br />
Adding repository 'home_tiwai_openSUSE_11.0' [done]<br />
Adding repository 'home_sjcundy_openSUSE_11.0' [done]<br />
Adding repository 'home_hmacht_openSUSE_11.0' [done]<br />
Adding repository 'home_marcinzalewski_openSUSE_11.0' [done]<br />
Adding repository 'home_beyerle_openSUSE_11.0' [done]<br />
Adding repository 'home_dsteuer_openSUSE_11.0' [done]<br />
Adding repository 'M17N_openSUSE_11.0' [done]<br />
Adding repository 'home_jefferyfernandez_openSUSE_11.0' [done]<br />
Adding repository '_distribution_11.0_repo_oss_suse' [done]<br />
Adding repository 'home_maw_bzr_openSUSE_11.0' [done]<br />
Repository 'FATE' is up to date.<br />
Repository 'KDE 4.1.x Packages (openSUSE_11.0)' is up to date.<br />
Repository 'The (default) Factory KDE 4 desktop with extra apps (openSUSE_11.0)' is up to date.<br />
Repository 'Current Qt 4.x packages (openSUSE_11.0)' is up to date.<br />
Retrieving repository 'VirtualBox' metadata [done]<br />
Building repository 'VirtualBox' cache [done]<br />
Repository 'Latest YaST svn snapshots (openSUSE_11.0)' is up to date.<br />
Repository 'Python and Python Modules (openSUSE_11.0)' is up to date.<br />
Repository 'home:jnweiger' is up to date.<br />
Repository 'PackageKit experiments (openSUSE_11.0)' is up to date.<br />
Repository 'Network Utilities (openSUSE_11.0)' is up to date.<br />
Repository 'openSUSE-11.0' is up to date.<br />
Repository 'openSUSE-11.0-NONOSS' is up to date.<br />
Repository 'openSUSE-11.0-Update' is up to date.<br />
Repository 'openSUSE.org tools (openSUSE_11.0)' is up to date.<br />
Repository 'outdated' is up to date.<br />
[/sourcecode]</p>
<p>Did you see how zypper automatically added the needed repositories? (it also would remove them if in the future the service does not list them).</p>
<p>Now, let list them:</p>
<p>Now if we list the services:</p>
<p>[sourcecode wraplines="false"]<br />
# zypper ls<br />
#  | Alias                       | Name                                                                | Enabled | Refresh | Type<br />
---+-----------------------------+---------------------------------------------------------------------+---------+---------+-------<br />
1  | myservice                   | myservice                                                           | Yes     | No      | ris<br />
2  | FATE                        | FATE                                                                | Yes     | Yes     | rpm-md<br />
3  | KDE_KDE4_Factory_Desktop    | KDE 4.1.x Packages (openSUSE_11.0)                                  | Yes     | Yes     | rpm-md<br />
4  | KDE_KDE4_Factory_Extra-Apps | The (default) Factory KDE 4 desktop with extra apps (openSUSE_11.0) | Yes     | Yes     | rpm-md<br />
5  | KDE_Qt                      | Current Qt 4.x packages (openSUSE_11.0)                             | Yes     | No      | rpm-md<br />
6  | Virtualization:VirtualBox   | VirtualBox                                                          | Yes     | No      | rpm-md<br />
7  | YaST_SVN                    | Latest YaST svn snapshots (openSUSE_11.0)                           | Yes     | Yes     | rpm-md<br />
8  | devel_languages_python      | Python and Python Modules (openSUSE_11.0)                           | Yes     | Yes     | rpm-md<br />
9  | home:jnweiger               | home:jnweiger                                                       | Yes     | Yes     | rpm-md<br />
10 | home_dmacvicar_packagekit   | PackageKit experiments (openSUSE_11.0)                              | Yes     | No      | rpm-md<br />
11 | network_utilities           | Network Utilities (openSUSE_11.0)                                   | Yes     | Yes     | rpm-md<br />
12 | openSUSE-11.0               | openSUSE-11.0                                                       | Yes     | No      | yast2<br />
13 | openSUSE-11.0-NONOSS        | openSUSE-11.0-NONOSS                                                | Yes     | No      | yast2<br />
14 | openSUSE-11.0-Update        | openSUSE-11.0-Update                                                | Yes     | No      | rpm-md<br />
15 | openSUSE_Tools              | openSUSE.org tools (openSUSE_11.0)                                  | Yes     | No      | rpm-md<br />
16 | outdated                    | outdated                                                            | Yes     | No      | rpm-md<br />
17 | packman                     | packman                                                             | Yes     | Yes     | rpm-md<br />
18 | rpms                        | rpms                                                                | Yes     | No      | rpm-md<br />
19 | ruby                        | Ruby                                                                | No      | No      | rpm-md<br />
20 | zypp_svn                    | ZYPP SVN Builds (openSUSE_11.0)                                     | Yes     | Yes     | rpm-md<br />
[/sourcecode]</p>
<p>Do you see that all the added repositories are &ldquo;hidden&rdquo; behind the added service.</p>
<p>If you want to see them, then you need to list the repositories instead:</p>
<p>[sourcecode wraplines="false"]<br />
# zypper lr<br />
#  | Alias                               | Name                                                                | Enabled | Refresh<br />
---+-------------------------------------+---------------------------------------------------------------------+---------+--------<br />
1  | Education_desktop_openSUSE_11.0     | Education_desktop_openSUSE_11.0                                     | No      | Yes<br />
2  | FATE                                | FATE                                                                | Yes     | Yes<br />
3  | KDE_KDE4_Factory_Desktop            | KDE 4.1.x Packages (openSUSE_11.0)                                  | Yes     | Yes<br />
4  | KDE_KDE4_Factory_Extra-Apps         | The (default) Factory KDE 4 desktop with extra apps (openSUSE_11.0) | Yes     | Yes<br />
5  | KDE_Qt                              | Current Qt 4.x packages (openSUSE_11.0)                             | Yes     | No<br />
6  | M17N_openSUSE_11.0                  | M17N_openSUSE_11.0                                                  | No      | Yes<br />
7  | Virtualization:VirtualBox           | VirtualBox                                                          | Yes     | No<br />
8  | YaST_SVN                            | Latest YaST svn snapshots (openSUSE_11.0)                           | Yes     | Yes<br />
9  | _distribution_11.0_repo_oss_suse    | _distribution_11.0_repo_oss_suse                                    | No      | Yes<br />
10 | devel_languages_python              | Python and Python Modules (openSUSE_11.0)                           | Yes     | Yes<br />
11 | home:jnweiger                       | home:jnweiger                                                       | Yes     | Yes<br />
12 | home_beyerle_openSUSE_11.0          | home_beyerle_openSUSE_11.0                                          | No      | Yes<br />
13 | home_dmacvicar_packagekit           | PackageKit experiments (openSUSE_11.0)                              | Yes     | No<br />
14 | home_dsteuer_openSUSE_11.0          | home_dsteuer_openSUSE_11.0                                          | No      | Yes<br />
15 | home_hmacht_openSUSE_11.0           | home_hmacht_openSUSE_11.0                                           | No      | Yes<br />
16 | home_jefferyfernandez_openSUSE_11.0 | home_jefferyfernandez_openSUSE_11.0                                 | No      | Yes<br />
17 | home_marcinzalewski_openSUSE_11.0   | home_marcinzalewski_openSUSE_11.0                                   | No      | Yes<br />
18 | home_maw_bzr_openSUSE_11.0          | home_maw_bzr_openSUSE_11.0                                          | No      | Yes<br />
19 | home_sjcundy_openSUSE_11.0          | home_sjcundy_openSUSE_11.0                                          | No      | Yes<br />
20 | home_tiwai_openSUSE_11.0            | home_tiwai_openSUSE_11.0                                            | No      | Yes<br />
21 | network_utilities                   | Network Utilities (openSUSE_11.0)                                   | Yes     | Yes<br />
22 | openSUSE-11.0                       | openSUSE-11.0                                                       | Yes     | No<br />
23 | openSUSE-11.0-NONOSS                | openSUSE-11.0-NONOSS                                                | Yes     | No<br />
24 | openSUSE-11.0-Update                | openSUSE-11.0-Update                                                | Yes     | No<br />
25 | openSUSE_Tools                      | openSUSE.org tools (openSUSE_11.0)                                  | Yes     | No<br />
26 | outdated                            | outdated                                                            | Yes     | No<br />
27 | packman                             | packman                                                             | Yes     | Yes<br />
28 | rpms                                | rpms                                                                | Yes     | No<br />
29 | ruby                                | Ruby                                                                | No      | No<br />
30 | server_mail_openSUSE_11.0           | server_mail_openSUSE_11.0                                           | No      | Yes<br />
31 | zypp_svn                            | ZYPP SVN Builds (openSUSE_11.0)                                     | Yes     | Yes<br />
[/sourcecode]</p>
<p>There you have them all. You should also note that service configuration is very similar to repository configuration. Only services.d intead of repos.d.</p>
<h2>Conclusion</h2>
<p>As you can see, services implement a kind of &ldquo;black box&rdquo; repository, that allows subscription to dynamic repository sets. The concept is simple, optional (you can not use them at all), and the potential is very big, if people start to offer them.</p>
