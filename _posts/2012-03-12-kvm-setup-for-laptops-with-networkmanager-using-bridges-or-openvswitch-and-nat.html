---
layout: post
title: kvm setup for laptops with NetworkManager using bridges or openvswitch and
  NAT
date: 2012-03-12 10:03:16.000000000 +01:00
type: post
published: true
status: publish
categories:
- Software
tags:
- suse
meta:
  _edit_last: '34818'
  draftfeedback_requests: a:2:{s:16:"jfehlig@suse.com";a:3:{s:3:"key";s:13:"4f5a2c6e0cadb";s:4:"time";s:10:"1331309678";s:7:"user_id";s:5:"34818";}s:15:"cthiel@suse.com";a:3:{s:3:"key";s:13:"4f5a2c6e7c5bf";s:4:"time";s:10:"1331309678";s:7:"user_id";s:5:"34818";}}
  draft_feedback: |-
    a:2:{s:16:"jfehlig@suse.com";a:1:{i:0;a:2:{s:4:"time";s:10:"1331318428";s:7:"content";s:265:" Looks good!  This is very similar to libvirt's default NAT'd network - http://wiki.libvirt.org/page/Networking#NAT_forwarding_.28aka_.22virtual_networks.22.29

    Also, it reminds me that libvirt does not have support for explicitly specifying the vif downscript :-/.";}}s:15:"cthiel@suse.com";a:1:{i:0;a:2:{s:4:"time";s:10:"1331327269";s:7:"content";s:216:" Hi Duncan,

    is the xenserver configuration reference still valid? Depending on if the submission gets accepted, you might want to remove that part.

    Otherwise I really like this write up! Publish it!

    Best
    Christoph";}}}
author:
  login: duncan
  email: dmacvicar@gmail.com
  display_name: duncan
  first_name: Duncan
  last_name: Mac-Vicar P.
---
<p>On my workstation I have a static network setup: I don't give an ip to eth0 but configure dhcp to give the ip to a bridge br0 attached to eth0. Then qemu-kvm creates tap devices attached to the bridge, getting ip's in the same network as the host.</p>
<p>On my laptop I run NetworkManager, which does not play well with bridges. It seems that in other distributions you can tell the network configuration to use NetworkManager for certain interfaces only (which is still not exactly what I want). After lot of reading, I found a configuration that fits my needs.</p>
<p>The idea is to create a bridge, and instead of having it attached to eth0 (which is controlled by NetworkManager), we create the bridge in a separate network and use NAT to have the VMs access the internet.</p>
<p>I <a href="http://patchwork.test.kernel.org/patch/2687/">found a script by Amos Kong that setups the network</a> (adapted to the paths of brctl in openSUSE):</p>
<p>[sourcecode language="bash"]<br />
#!/bin/bash</p>
<p># Script used to add/remove setup of private bridge and dnsmasq<br />
# @author Amos Kong </p>
<p>brname='br0'</p>
<p>add_br()<br />
{<br />
    echo &quot;add new private bridge&quot;<br />
    /sbin/brctl addbr $brname<br />
    echo 1 &gt; /proc/sys/net/ipv6/conf/$brname/disable_ipv6<br />
    echo 1 &gt; /proc/sys/net/ipv4/ip_forward<br />
    /sbin/brctl stp $brname on<br />
    /sbin/brctl setfd $brname 0<br />
    ifconfig $brname 192.168.58.1<br />
    ifconfig $brname up<br />
    # add iptable entry as libvirt, then guest can access public network<br />
    iptables -t nat -A POSTROUTING -s 192.168.58.254/24 ! -d 192.168.58.254/24 -j MASQUERADE<br />
   /etc/init.d/dnsmasq stop<br />
    /etc/init.d/tftpd-hpa stop 2&amp;gt;/dev/null<br />
    dnsmasq --strict-order --bind-interfaces --listen-address 192.168.58.1 --dhcp-range 192.168.58.2,192.168.58.254 $tftp_cmd<br />
}</p>
<p>del_br()<br />
{<br />
    echo &quot;cleanup bridge setup&quot;<br />
    kill -9 `pgrep dnsmasq|tail -1`<br />
    ifconfig $brname down<br />
    /sbin/brctl delbr $brname<br />
   iptables -t nat -D POSTROUTING -s 192.168.58.254/24 ! -d 192.168.58.254/24 -j MASQUERADE<br />
}</p>
<p># clean original setup first<br />
del_br 2&gt;/dev/null</p>
<p>if [[ $# &gt; 0 ]];then<br />
    if [[ $# = 2 ]];then<br />
        # setup tftp function<br />
       tftp_cmd=&quot; --enable-tftp --tftp-root $1 --dhcp-boot $2 --dhcp-no-override&quot;<br />
    fi<br />
    add_br<br />
fi<br />
[/sourcecode]</p>
<p>Calling the script with no arguments will remove the bridge. Calling it with "1" as argument setups the bridge and NAT and also runs dnsmasq (dhcp server and dns cache: zypper install dnsmasq) on the bridge. Calling it with 2 will also setup a tftp server on the dnsmasq process.</p>
<p>Then you need a pair of scripts for qemu, which are called with the tap device as a parameter.</p>
<p>[sourcecode language="bash"]<br />
#!/bin/sh<br />
switch='br0'<br />
/sbin/ifconfig $1 0.0.0.0 up<br />
/sbin/brctl addif ${switch} $1<br />
/sbin/brctl setfd ${switch} 0<br />
/sbin/brctl stp ${switch} off<br />
[/sourcecode]</p>
<p>And for bringing down the interface:</p>
<p>[sourcecode language="bash"]<br />
#!/bin/sh<br />
switch='br0'<br />
/sbin/ifconfig $1 0.0.0.0 down<br />
/sbin/brctl delif ${switch} $1<br />
[/sourcecode]</p>
<p>Then you run the VM like:</p>
<p>[sourcecode language="bash"]<br />
qemu-kvm -boot c -drive file=./disk.qcow2,if=virtio -m 2500 -net nic,macaddr=XX:XX:XX:XX:XX:XX -net tap,script=script-ifup,downscript=script-ifdown &quot;$@&quot;<br />
[/sourcecode]</p>
<p>You can use the same setup with openvswitch. There is a package in the network project of the build service, but the package is tied to the xenserver configuration so I did not get it running. I redid the package based on the Debian one, which not only is separated in subpackages but does not assume you are running Xen. The package is available <a href="https://build.opensuse.org/package/binaries?package=openvswitch&amp;project=home%3Admacvicar%3Abranches%3Anetwork&amp;repository=openSUSE_12.1">here</a> until the submit request is accepted.</p>
<p>Then change on the setup script the brctl addbr line to use ovs-vsctl:</p>
<p>[sourcecode lang="bash" highlight="4"]<br />
add_br()<br />
{<br />
    echo &quot;add new private bridge&quot;<br />
    ovs-vsctl add-br $brname<br />
    echo 1 &gt; /proc/sys/net/ipv6/conf/$brname/disable_ipv6<br />
    echo 1 &gt; /proc/sys/net/ipv4/ip_forward<br />
    /sbin/brctl stp $brname on<br />
    /sbin/brctl setfd $brname 0<br />
    ...<br />
[/sourcecode]</p>
<p>And the for the qemu scripts, use ovs-vsctl add-port instead of brctl addif:</p>
<p>[sourcecode language="bash" highlight="4"]<br />
#!/bin/sh<br />
switch='br0'<br />
/sbin/ifconfig $1 0.0.0.0 up<br />
ovs-vsctl add-port ${switch} $1<br />
/sbin/brctl setfd ${switch} 0<br />
/sbin/brctl stp ${switch} off<br />
[/sourcecode]</p>
<p>And for bringing down the interface:</p>
<p>[sourcecode language="bash" highlight="4"]<br />
#!/bin/sh<br />
switch='br0'<br />
/sbin/ifconfig $1 0.0.0.0 down<br />
ovs-vsctl del-port ${switch} $1<br />
[/sourcecode]</p>
