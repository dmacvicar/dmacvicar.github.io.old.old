---
layout: post
title: 'A refactoring journey: the control center'
date: 2008-12-17 00:26:57.000000000 +01:00
type: post
published: true
status: publish
categories: []
tags:
- newkde
- newsuse
- qt
- software
- suse
- yast
meta:
  posterous_6c96d52da40a5d7e34be538822acc826_post_id: '48645136'
  posterous_6c96d52da40a5d7e34be538822acc826_permalink: http://duncan.mac-vicar.com/a-refactoring-journey-the-control-center
  _oembed_a8bfa54c985c98be194490d134f2fecc: "{{unknown}}"
  _oembed_23e00d1dee25fb485b4d0d25f7caccd9: "{{unknown}}"
  _oembed_e718e0e77aa7802845bbed68e2307210: "{{unknown}}"
  _oembed_a714cd8647029d15ca21f1ef8b6def3f: "{{unknown}}"
  _oembed_02d1026f1099234f365b64d6c44c6650: "{{unknown}}"
  _oembed_1297c88e55cde1cdd9da1d9b92dc4d74: "{{unknown}}"
  _oembed_30479330aaa72429191927815d793e40: "{{unknown}}"
  _oembed_6bb538b3193cc4ace96c2a41009bcaad: "{{unknown}}"
  _oembed_2316d3177202e59dc6c5ffac4b91d904: "{{unknown}}"
  _oembed_734100644ff50ba80d700c5624eab722: "{{unknown}}"
  _oembed_0cca41adc56ca3bf31f7e6d8171d95fd: "{{unknown}}"
  _oembed_f48ba9547952c371134e12ffef9461e6: "{{unknown}}"
  _oembed_6cfd4a117de81d0a917ea6208e1aa697: "{{unknown}}"
  _oembed_07872e202cecb345a7bb968c82230c76: "{{unknown}}"
  _oembed_2db5568314c32fe80eb0ccceeba49311: "{{unknown}}"
  _oembed_3cc59470d87a15fb4cb36779f7a6970e: "{{unknown}}"
  _oembed_739251431923bd26de1e63333ebc2a9d: "{{unknown}}"
  _oembed_e7c7c7a4ca94b73d28618fb41945bb97: "{{unknown}}"
  _oembed_7bf5c9ab536be29082d52877795da757: "{{unknown}}"
  _oembed_cf5ca0829bff3578c08a714e6f61e857: "{{unknown}}"
  _oembed_7dff6af59735c25d4532ada2abd98974: "{{unknown}}"
  _oembed_dd83b8e03c656a2760b72345f7bbd1b7: "{{unknown}}"
  _oembed_f413117552f24c62b2cd8002189ea7bd: "{{unknown}}"
  _oembed_96b2dd1aea34138d736cb60e281b9ba9: "{{unknown}}"
  _oembed_a6ed1acf86e7e7e4c7e8502ed234687b: "{{unknown}}"
  _oembed_963f519ae408fc204e90f82f8254a6b4: "{{unknown}}"
  _oembed_e296ef929af48ed79789d8e37ddd9aff: "{{unknown}}"
  _oembed_d8cdf42785c603c228f929f409d84276: "{{unknown}}"
  _oembed_a5c8088eacd6e356a903ee6ebf03278d: "{{unknown}}"
  _oembed_1ffe71b19969e324cf9ae755aae69c99: "{{unknown}}"
  _oembed_c4d6d285be74e5d48af3156f70034b5d: "{{unknown}}"
  _oembed_687c9fdfce9631f093d903b9d7fda05d: "{{unknown}}"
  _oembed_a3025929553fd0ca92b9bafcbfb6765b: "{{unknown}}"
  _oembed_fd726a7eaf20e582c6af7938919cd323: "{{unknown}}"
  _oembed_5f5b5472095b856c15f5620ec88362c3: "{{unknown}}"
  _oembed_757b45d5bf101b90b95c963fe528c6e2: "{{unknown}}"
  _oembed_7a4937144e833ac193fa958c2fa09985: "{{unknown}}"
  _oembed_b1058c5285b0abbf70ffc41a8d75d914: "{{unknown}}"
  _oembed_e6e9022a04d2591f725d34dd59c520d5: "{{unknown}}"
  _oembed_eb2b76ff50c640d9dcd28df7c1cdefc8: "{{unknown}}"
  _oembed_ad0025a0e0ecd27cdfebeb44c89a8e8f: "{{unknown}}"
  _oembed_201408e3a876ee2ccdbf153db3b54e2f: "{{unknown}}"
  _oembed_a9604f1bb9523edcbfea1bf054510b75: "{{unknown}}"
  _oembed_20e86baf9cbec53d60338ce7fdc4f020: "{{unknown}}"
  _oembed_d198ae787bd096655d068b5b328a0bf0: "{{unknown}}"
  _oembed_6b307058075a19b48b9d2641494135fe: "{{unknown}}"
  _oembed_41a10c9d60a894211547e0508d101774: "{{unknown}}"
  _oembed_6188127854e39fe1fbcd63c03b070145: "{{unknown}}"
  _oembed_7ad503a798e86f6102972bd55275fe2f: "{{unknown}}"
  _oembed_76f45e4233a562ea1b338bc385087dc1: "{{unknown}}"
  _oembed_244e396a0089a648cca37ceef7ac964b: "{{unknown}}"
  _oembed_185b02c70298f6ae007bf17adcba6239: "{{unknown}}"
  _oembed_260e1b8151f71042067245b7ba5c2f9a: "{{unknown}}"
author:
  login: duncan
  email: dmacvicar@gmail.com
  display_name: duncan
  first_name: Duncan
  last_name: Mac-Vicar P.
---
<p>
    It is almost Christmas and things are getting more quiet and there is now some time to look at pending TODOs. I mean all those things that did not make into 11.1 because priorities.</p>
<p>## The problem</p>
<p>The Qt control center is an ancient piece of code, and it still is a Qt 3.x application.</p>
<p>You may know how it looks:</p>
<p>![original][12]</p>
<p>We already have a [feature for a reorganization of the control center][7]. [Thomas G&ouml;ttlicher][15], [Jens Daniel Schmidt][16], [J&ouml;rg Kress][14] and [Martin Schmidkunz][16] [worked last year on proposals][8]. I want to leave look and feel out of this post for now. (When it comes to which color to use to paint the walls, everyone has an opinion). I wanted to focus on:</p>
<p>* [The fact that it still is a Qt 3.x][9] application<br />
* The code is not easy to port to Qt 4.x, even more difficult to change the look and feel (which would help for [the feature mentioned above][7] )</p>
<p>The main reason of why the code became so inflexible is the mixing of presentation with data items everywhere. Yes, not only the control center suffers from this problem but also the Qt package selector.</p>
<p>Qt 4.x has, among a lot of unmatched features, the ability to use a [Model/View paradigm][18]. This means, you describe a model, and then you just plug it into a view, and it will be displayed according to the widget's context, instead of sub classing widgets just to hold data on the user interface.</p>
<p>I have to admit that it is not the first time I look into Qt's Model/View, but in order to understand it, one needs to dig in some real life problem because it has some concepts like indexes, views, delegates, etc, which start to make sense once one adapts it to the specific problem.</p>
<p>So, my challenge was to add a model architecture to the control center in order to make then trivial to let other people choose the wall color ;-) and also enable other innovations. For example [Stano][19] hacked a ycp script to retrieve summary information from the configuration (I can't wait to integrate that).</p>
<p>## Step 0. Find out where are we.</p>
<p>Thomas G&ouml;ttlicher already did [some research on using the KDE4 system-settings style views][11]. This shown that some widgets could be reused (like KCategorizedView), but also showed that pieces like the SystemSettingsModel are too complex for what we need.</p>
<p>## Step 1. Compile old control center on Qt 4.x</p>
<p>I took the old control center, [branched it][10] and started the boring work to getting it to compile with Qt 4.x. This involved setting cmake up as I did not wanted to waste time figuring how to convert an autotools project to Qt 4.x.</p>
<p>In this stage one sees much design decisions that either help or hurt when porting. Also opportunities, for example the control center had its own .ini file parser, which I replaced with the QSettings class. Note, QSettings is there since Qt 3.3.</p>
<p>At the same time I got it compiling in Qt 4.x, I extracted some of the module listing code to an QAbstractItemModel and created a small test program for it that I could run in parallel.</p>
<p>My model could be plugged into a view and display the groups, with one line of code:</p>
<p>![groups model][1]</p>
<p>After getting familiar with the code, and learning it, I decided it was almost impossible to plug my model in the current code. Why did I tried then? Because [reading code is always harder than writing it, therefore there is always a tendency to rewrite from scratch][13], and I wanted to be really sure it was not the "reading code effect".</p>
<p>## Step 2: start with a cleaner base</p>
<p>I took [Thomas codebase][11] and compiled it. I realized it was easier. I only needed to get rid of the systemsettings code. I only needed the KCategorizedView part, or even a plain QListView if I had the right model.</p>
<p>Once the code was removed, I needed a modules model (analog to the groups model). After writting some code, I felt like I was writing the same thing again: a model that lists what it is in .desktop files. Closed both models and focused on a DesktopFilesModel as a base. Once this was done, the groups and modules model was a few lines of code (mainly setting the right configure time YaST paths). So I had a modules model too:</p>
<p>![groups model][2]</p>
<p>## Step 3: KCategorizedView</p>
<p>This component worked out of the box when I plugged my model:</p>
<p>![one category][3]</p>
<p>Except that it only displayed a hardcoded category. One needs to enhance the model to reply to the CategoryDisplayRole, which required to start thinking better about the structure of the models and add utility methods to query groups for modules given an index and similar methods.</p>
<p>At the same time once you see it on the screen you get a feeling when the view is querying the model (speed and debug lines), which resulted in a basic cache infrastructure for the base .desktop files model.</p>
<p>The result:</p>
<p>![categories][4]</p>
<p>## Step 4: Profit from the new structure</p>
<p>At this point I realized there were too many items on the screen, but also I realized how trivial was to add a docking at the right with the group list, or how trivial it would be to set the proxy model to filter certain groups. Just for playing, I added a search bar:</p>
<p>![search][5]</p>
<p>and then a groups list dock (which you can move around the main window):</p>
<p>![group list][6].</p>
<p>## Now what?</p>
<p>Note that none of these screenshots mean "this is how the control center will look". The focus is still on the infrastructure that enables us to try more radical approaches. For example, the old control center look and feel is trivial to emulate.</p>
<p>Will it be the old? the new? configurable? We don't know yet. There is still work to do before we focus on the look and feel.</p>
<p> [1]: <a href="http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/1-modulegroupsmodel.png">http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/1-modulegroupsmo...</a><br />
 [2]: <a href="http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/2-modulesmodel.png">http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/2-modulesmodel.png</a><br />
 [3]: <a href="http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/3-onecategory.png">http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/3-onecategory.png</a><br />
 [4]: <a href="http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/4-categories.png">http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/4-categories.png</a><br />
 [5]: <a href="http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/5-searchbar.png">http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/5-searchbar.png</a><br />
 [6]: <a href="http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/6-dockgroups.png">http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/6-dockgroups.png</a><br />
 [7]: <a href="https://features.opensuse.org/?rm=feature_show&amp;id=302306">https://features.opensuse.org/?rm=feature_show&amp;id=302306</a><br />
 [8]: <a href="http://en.opensuse.org/YaST/Development/New_Control_Center/">http://en.opensuse.org/YaST/Development/New_Control_Center/</a><br />
 [9]: <a href="https://features.opensuse.org/?rm=feature_show&amp;id=305550">https://features.opensuse.org/?rm=feature_show&amp;id=305550</a><br />
 [10]: <a href="http://svn.opensuse.org/svn/yast/branches/tmp/dmacvicar/control-center-qt4/">http://svn.opensuse.org/svn/yast/branches/tmp/dmacvicar/control-center-qt4/</a><br />
 [11]: <a href="http://svn.opensuse.org/svn/yast/branches/tmp/tgoettlicher/yast2cc_rewrite/">http://svn.opensuse.org/svn/yast/branches/tmp/tgoettlicher/yast2cc_rewrite/</a><br />
 [12]: <a href="http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/0-original.png">http://www.suse.de/~dmacvicar/screenshots/control-center-qt4/0-original.png</a><br />
 [13]: <a href="http://www.joelonsoftware.com/articles/fog0000000069.html">http://www.joelonsoftware.com/articles/fog0000000069.html</a><br />
 [14]: <a href="http://joshs.littlecornerofthe.net/blog/">http://joshs.littlecornerofthe.net/blog/</a><br />
 [15]: <a href="http://en.opensuse.org/User:Tgoettlicher">http://en.opensuse.org/User:Tgoettlicher</a><br />
 [16]: <a href="http://en.opensuse.org/User:Jdsn">http://en.opensuse.org/User:Jdsn</a><br />
 [17]: <a href="http://en.opensuse.org/User:Mschmidkunz">http://en.opensuse.org/User:Mschmidkunz</a><br />
 [18]: <a href="http://doc.trolltech.com/4.4/model-view-programming.html">http://doc.trolltech.com/4.4/model-view-programming.html</a><br />
 [19]: <a href="http://en.opensuse.org/User:Visnov">http://en.opensuse.org/User:Visnov</a></p>
