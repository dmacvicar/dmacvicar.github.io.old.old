---
layout: post
title: Easy development & test environment for Linux kernels
date: 2007-05-28 04:22:56.000000000 +02:00
type: post
published: true
status: publish
categories: []
tags:
- newsuse
- suse
meta:
  posterous_6c96d52da40a5d7e34be538822acc826_permalink: http://duncan.mac-vicar.com/easy-development-test-environment-for-linux-k
  posterous_6c96d52da40a5d7e34be538822acc826_post_id: '48644136'
  _oembed_7127331181d2bfe74d11b06533697d55: "{{unknown}}"
  _oembed_64a7e7954814defc79a879dabe61fdd1: "{{unknown}}"
  _oembed_78b7547bd730a9c1ba6921f352c0f89a: "{{unknown}}"
  _oembed_2610ae3ef5ee0e7c6daa1c18f542b9af: "{{unknown}}"
  _oembed_b5aa4b45bcadcdaafb83266edf317653: "{{unknown}}"
  _oembed_141791b05e9252b29fe3ec6dbba55182: "{{unknown}}"
author:
  login: duncan
  email: dmacvicar@gmail.com
  display_name: duncan
  first_name: Duncan
  last_name: Mac-Vicar P.
---
<p>
    I really enjoy learning new things, and I spend most of my computer time digging into stuff. My productive times always coincide with the quality of my development environment.</p>
<p>If you can't keep up with a easy and own system to checkout, develop, compile and try code, it is very likely you will spend more time doing meta-development.</p>
<p>I have been always interested into learning more about the kernel. I would conform myself with having a sandbox where easily modify and try things, so if one day I feel like doing something, I could just sit and start.</p>
<p>We are going to use [QEMU][qemu], a PC emulator, which is quite nice because:</p>
<p>* It can launch kernels directly. Uses some magic to load the kernel in the emulator and boot it, so it is not needed to setup a tftp server with a kernel.<br />
* It doesn't require kernel modules, except if you need more speed, then you can use kqemu.<br />
* It is free</p>
<p>The fact QEMU can launch a kernel directly, means we can launch the image we just compiled.</p>
<p>To get the Linux kernel source do:</p>
<div class="CodeRay">
<div class="code">
<pre>git-clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux-2.6.git linux</pre>
</div>
</div>
<p>To avoid having to create a image of the system to use as a root disk all the time, we can just mount a directory on our own machine via NFS.</p>
<div class="CodeRay">
<div class="code">
<pre>make xconfig</pre>
</div>
</div>
<p>Be sure to enable nfsroot option, which at the same time requires kernel ip level autoconfiguration. Also be sure to put your network card in the kernel, not as a module, otherwise you will need to create a initrd image too.</p>
<div class="CodeRay">
<div class="code">
<pre>make bzimage
 make modules</pre>
</div>
</div>
<p>We have everything ready to boot the kernel. But we need a root filesystem too. We will use the [Kiwi][kiwi] tool to generate a custom root filesystem. With kiwi you can generate a root filesystem and then turn it into a LiveDVD, a USB stick distro or a Xen image. For us the first stage is enough. See the website for info how to get SUSE packages for Kiwi</p>
<p>Edit /usr/share/kiwi/image/netboot/suse-10.2/config.xml and now create the image:</p>
<div class="CodeRay">
<div class="code">
<pre>kiwi --root /space/nfsroot/work --prepare /usr/share/kiwi/image/netboot/suse-10.2</pre>
</div>
</div>
<p>When trying this, I got a strange error. Looking at work.log, the problem was when kiwi called smart to install the packages, at commit time, the rpm database did not exist.</p>
<div class="CodeRay">
<div class="code">
<pre>Committing transaction...^M
 error: cannot open Packages index using db3 - No such file or directory (2)^M
 error: cannot open Packages database in work/var/lib/rpm</pre>
</div>
</div>
<p>So I edited /usr/share/kiwi/modules/KIWIManager.pm and near line 630 I added these two lines:</p>
<div class="CodeRay">
<div class="code">
<pre>print $fd &quot;mkdir -p $root/var/lib/rpmn&quot;;
 print $fd &quot;rpm --root $root --initdbn&quot;;</pre>
</div>
</div>
<p>I am not sure if it the right fix. I will ask on the mailing list later. But the workaround worked for me. The final section of the code looks now like:</p>
<div class="CodeRay">
<div class="code">
<pre># Add package manager to package list
 #------------------------------------------
 push (@packs,$manager);
 #==========================================
 # Create screen call file
 #------------------------------------------
 print $fd &quot;smart update @channelListn&quot;;
 print $fd &quot;mkdir -p $root/var/lib/rpmn&quot;;
 print $fd &quot;rpm --root $root --initdbn&quot;;
 print $fd &quot;test $? = 0 &amp;&amp; smart install @packs @installOptsn&quot;;
 print $fd &quot;echo $? &gt; $screenCall.exitn&quot;;
 print $fd &quot;rm -f $root/etc/smart/channels/*n&quot;;</pre>
</div>
</div>
<p>Edit /etc/exports to share that directory via NFS:</p>
<div class="CodeRay">
<div class="code">
<pre>/space/nfsroot/work   (rw,root_squash,sync)</pre>
</div>
</div>
<p>Now, go to your kernel source directory and launch it:</p>
<div class="CodeRay">
<div class="code">
<pre>qemu -kernel arch/i386/boot/bzImage
 -append
  &quot;nfsroot=192.168.0.101:/space/nfsroot/work,rw
   ip=::::diskless:eth0:dhcp root=/dev/nfs&quot;
 -hda /dev/zero -net nic -net user</pre>
</div>
</div>
<p>Final result:</p>
<div class="p_embed p_image_embed">
<img alt="" src="{{ site.baseurl }}/assets/bootvb3.png" />
</div>
<p>I still can't login on the machine, but that is a minor issue. Some error messages about read-only filesystem too.</p>
<p>Things I haven't figured  yet:</p>
<p>* How to install modules to the root filesystem (something like make modules_install DESTDIR=/space/image)</p>
<p> [qemu]: <a href="http://fabrice.bellard.free.fr/qemu/">http://fabrice.bellard.free.fr/qemu/</a><br />
 [kiwi]: <a href="http://en.opensuse.org/Build_Service/KIWI">http://en.opensuse.org/Build_Service/KIWI</a></p>
